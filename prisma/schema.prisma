generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

model guilds {
  id                    String                  @id @db.VarChar(25)
  lang                  String?                 @default("es-es") @db.VarChar(10)
  TicketChannel         String?                 @db.VarChar(30)
  TicketTranscripts     String?                 @db.VarChar(30)
  TicketMsg             String?                 @db.VarChar(30)
  TicketOpinions        String?                 @db.VarChar(30)
  proxmoxLogs           String?                 @db.VarChar(30)
  image                 String?                 @db.VarChar(250)
  mail                  mail?
  perfils               perfils[]
  virtualization_panels virtualization_panels[]
  guilds_commandos      guilds_commandos[]
}

model guilds_commandos {
  guildId String  @db.VarChar(50)
  CommId  String  @db.VarChar(50)
  enabled Boolean @default(false)
  guilds  guilds  @relation(fields: [guildId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_guilds_commandos_guilds")

  @@id([guildId, CommId])
}

model mail {
  guildId   String  @id @db.VarChar(30)
  host      String? @db.VarChar(30)
  port      Int     @default(465)
  secure    Int     @default(1) @db.TinyInt
  loginType String  @db.VarChar(50)
  loginUser String  @default("") @db.VarChar(255)
  loginPass String  @default("") @db.VarChar(255)
  guilds    guilds  @relation(fields: [guildId], references: [id], onUpdate: Restrict, map: "FK1_guild")
}

model perfil_permisos {
  perfilId Int
  permId   Int
  perfils  perfils  @relation(fields: [perfilId], references: [id], onDelete: Cascade, map: "FK1_perfil")
  permisos permisos @relation(fields: [permId], references: [id], onDelete: Cascade, map: "FK2_perms")

  @@id([perfilId, permId])
  @@index([permId], map: "FK2_perm")
}

model perfils {
  id              Int               @id @default(autoincrement())
  name            String            @db.VarChar(30)
  guildId         String            @db.VarChar(30)
  roleId          String            @db.VarChar(30)
  perfil_permisos perfil_permisos[]
  guilds          guilds            @relation(fields: [guildId], references: [id], onDelete: Cascade, map: "FK1_guilds")

  @@index([guildId, name], map: "guildId")
  @@index([guildId, roleId], map: "guildId_roleId")
}

model permisos {
  id              Int               @id @default(autoincrement())
  name            String            @db.VarChar(50)
  Descripcion     String?           @db.VarChar(255)
  perfil_permisos perfil_permisos[]
}

// Panel genérico para soportar diferentes tipos de virtualizadores
model virtualization_panels {
  id          Int      @id @default(autoincrement()) @db.UnsignedInt
  guildId     String   @db.VarChar(30)
  name        String   @db.VarChar(50) // Nombre descriptivo del panel
  type        String   @db.VarChar(20) // 'proxmox', 'vmware', 'hyper-v', etc.
  apiUrl      String   @db.VarChar(255) // URL base de la API
  credentials Json // Credenciales encriptadas (token, user/pass, etc.)
  config      Json? // Configuración específica del tipo
  active      Boolean  @default(true)
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  guilds     guilds             @relation(fields: [guildId], references: [id], onDelete: Cascade)
  vmMonitors vm_monitors[]

  @@unique([guildId, name])
  @@index([guildId, type])
  @@index([guildId, isDefault])
}

// Logs de acciones en las VMs
model vm_action_logs {
  id         Int      @id @default(autoincrement())
  vmId       String   @db.VarChar(50)
  userId     String   @db.VarChar(25)
  action     String   @db.VarChar(50) // start, stop, restart, etc.
  status     String   @db.VarChar(20) // success, error, pending
  details    Json? // Detalles adicionales
  error      String?  @db.Text // Error message si falla
  executedAt DateTime @default(now())

  @@index([vmId, executedAt])
  @@index([userId, executedAt])
}

// Permisos específicos para VMs
model vm_permissions {
  id          Int       @id @default(autoincrement())
  vmId        String    @db.VarChar(50)
  userId      String?   @db.VarChar(25) // Usuario específico
  roleId      String?   @db.VarChar(25) // O rol de Discord
  permissions Json // Array de permisos: ['start', 'stop', 'restart', 'console', 'stats']
  grantedBy   String    @db.VarChar(25) // Quien otorgó los permisos
  grantedAt   DateTime  @default(now())
  expiresAt   DateTime? // Opcional: permisos temporales

  @@index([vmId])
  @@index([userId])
  @@index([roleId])
}

model tickets {
  id                 Int                @id @default(autoincrement())
  guildId            String             @db.VarChar(25)
  channelId          String             @db.VarChar(25)
  usrId              String             @db.VarChar(25)
  category           Int
  transcript         String?            @db.Text
  closed             Boolean            @default(false)
  CreatedAt          DateTime           @default(now()) @db.Timestamp(0)
  tickets_categories tickets_categories @relation(fields: [category], references: [id], onUpdate: Restrict, map: "FK1_categorias")

  @@index([category], map: "FK1_categorias")
  @@index([channelId], map: "channelId")
  @@index([guildId], map: "guildId")
  @@index([usrId], map: "usrId")
}

model tickets_categories {
  id          Int       @id @default(autoincrement())
  guildId     String    @db.VarChar(25)
  name        String    @db.VarChar(30)
  description String    @db.VarChar(100)
  CategId     String?   @db.VarChar(25)
  tickets     tickets[]

  @@index([guildId], map: "guildId")
}

model traducciones {
  id    Int    @id @default(autoincrement())
  lang  String @default("") @db.VarChar(5)
  key   String @default("") @db.VarChar(255)
  value String @db.LongText

  @@unique([lang, id], map: "lang")
  @@index([lang], map: "lang_index")
}

model vm_monitors {
  id        Int      @id @default(autoincrement())
  guildId   String   @db.VarChar(50)
  channelId String   @db.VarChar(50)
  messageId String   @unique @db.VarChar(50)
  panelId   Int      @db.UnsignedInt
  vmId      String   @db.VarChar(50)
  userId    String   @db.VarChar(50)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  panel virtualization_panels @relation(fields: [panelId], references: [id], onDelete: Cascade)
}
